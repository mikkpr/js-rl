import * as ROT from 'rot-js';
import { action } from './state';
import { Zones, Trigger } from './types';
import { ID } from './utils/id';
import { ENTITY_TYPES } from './entities';

const defaultMap = [
  '###########################################################',
  '#...............#..................#..................#...#',
  '#...............#..................#..................#...#',
  '#.........................................................#',
  '#....######.............######.............######.........#',
  '#.........................................................#',
  '#.........................................................#',
  '#.........................................................#',
  '#...........#..................#..................#.......#',
  '#.........................................................#',
  '#.........................................................#',
  '#........###########........###########........############',
  '#.........................................................#',
  '#.........................................................#',
  '#.......#..................#..................#...........#',
  '#.........................................................#',
  '#.........................................................#',
  '#..............#....#..............#....#..............#..#',
  '#..............#....#..............#....#..............#..#',
  '#..............#....#..............#....#..............#..#',
  '###########################################################'
];

export const setupMap = () => {
  const cells = [];
  for (const _y in defaultMap) {
    const y = parseInt(_y, 10);
    for (const _x in defaultMap[y].split('')) {
      const x = parseInt(_x, 10);
      const glyph = defaultMap[y][x];
      const type = glyph === '.' ? 'FLOOR' : 'WALL';
      cells.push({ x, y, type, glyph: glyph === '.' ? 'FLOOR' : 'WALL' });
    }
  }

  const zoneID = ID();
  const zones: Zones = {
    // random walk zone (top left 3x3 rect)
    [zoneID]: {
      cells: [[1, 1, 15, 3]],
      triggers: [{
        type: 'WITHIN',
        flags: ['PREVENT_DEFAULT_MOVE'],
        actions: [{
          type: 'RANDOM_WALK',
          payload: { },
          conditions: [
            [ 'entity', [ 'type', 'eq', ENTITY_TYPES.PLAYER]]
          ]
        }, {
          type: 'LOG_MESSAGE',
          payload: { message: 'The tall grass confuses you.' },
          conditions: [
            [ 'entity', [ 'type', 'eq', ENTITY_TYPES.PLAYER]]
          ]
        }]
      }],
      id: zoneID
    }
  };
  action('UPDATE_ZONES', { zones });

  action('UPDATE_CELLS', { cells });
};
